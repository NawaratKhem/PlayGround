#include <PubSubClient.h>
#include <Wire.h>
#include <ArduinoJson.h>
#include <WiFi.h>

// --- MQTT Configuration ---
const char* BROKER_ADDRESS = "broker.hivemq.com";
const int BROKER_PORT = 1883;
const char* TOPIC = "peeranat/esp32/sensor_data"; // Unified topic
const long PUBLISH_INTERVAL = 15000;      // Publish every 15 seconds

// --- RSSI-to-Distance Configuration ---
// Distance = 10 ^ ((RSSI_AT_1M - Current_RSSI) / (10 * PATH_LOSS_EXP))
const float RSSI_AT_1M = -40.0; // RSSI reading at 1 meter (Calibration Point)
const float PATH_LOSS_EXP = 2.2; // Path Loss Exponent (Environmental factor)

// --- Sensor Pins ---
const int LDR_PIN = 36;           // Analog LDR input
const int I2C_SDA_PIN = 4;        // I²C SDA
const int I2C_SCL_PIN = 5;        // I²C SCL
const uint8_t SENSOR_ADDRESS = 0x4D; // I²C temperature sensor address (e.g., TMP102)
const uint8_t TEMP_REGISTER = 0x00;  // Register for temperature read

// --- Wi-Fi Credentials ---
const char* ssid = "coc-iot-lab";
const char* password = "computing";

// --- MQTT Setup ---
WiFiClient espClient;
PubSubClient client(espClient);
long lastPublishTime = 0;

// Function Prototypes
void setup_wifi();
void reconnect();
float readI2CTemperature();
void publish_data();

void setup() {
    Serial.begin(115200);
    pinMode(LDR_PIN, INPUT);
    Wire.begin(I2C_SDA_PIN, I2C_SCL_PIN);

    Serial.printf("I²C started on SDA=%d, SCL=%d\n", I2C_SDA_PIN, I2C_SCL_PIN);
    setup_wifi();
    client.setServer(BROKER_ADDRESS, BROKER_PORT);
}

void loop() {
    if (!client.connected()) reconnect();
    client.loop();

    // Check if it's time to publish
    if (millis() - lastPublishTime >= PUBLISH_INTERVAL) {
        lastPublishTime = millis();
        publish_data();
    }
}

// --- Sensor Read: I²C Temperature ---
float readI2CTemperature() {
    Wire.beginTransmission(SENSOR_ADDRESS);
    Wire.write(TEMP_REGISTER);
    if (Wire.endTransmission() != 0) {
        Serial.println("Error: I2C Temp sensor not found.");
        return -999.0;
    }

    Wire.requestFrom(SENSOR_ADDRESS, 2);
    if (Wire.available() == 2) {
        uint8_t msb = Wire.read();
        uint8_t lsb = Wire.read();
        uint16_t raw = (msb << 8) | lsb;
        // Convert raw 12-bit data (assuming TMP102 structure)
        int16_t signed_raw = raw >> 4;
        return signed_raw * 0.0625;  // 0.0625 °C/LSB
    }
    return -999.0;
}

// --- Data Publishing ---
void publish_data() {
    // Sensor Reads
    int ldrValue = analogRead(LDR_PIN);
    float temperature = readI2CTemperature();
    long rssi = WiFi.RSSI(); // Read current RSSI (dBm)

    // Calculate Distance (Log-Distance Path Loss Model)
    float distance = pow(10.0, (RSSI_AT_1M - rssi) / (10.0 * PATH_LOSS_EXP));

    // Create JSON Document
    StaticJsonDocument<200> doc;
    doc["device_id"] = "ESP32_A1";
    doc["ldr_raw"] = ldrValue;
    doc["temperature_c"] = temperature;
    doc["rssi_dbm"] = rssi;
    doc["distance_m"] = distance;

    char jsonBuffer[200];
    size_t n = serializeJson(doc, jsonBuffer);

    // Publish Data
    if (client.publish(TOPIC, jsonBuffer, n)) {
        Serial.printf("✅ Published JSON (RSSI: %ld dBm, Dist: %.2f m) -> %s: %s\n", rssi, distance, TOPIC, jsonBuffer);
    } else {
        Serial.printf("❌ Publish failed. MQTT state: %d\n", client.state());
    }
}

// --- Wi-Fi Setup ---
void setup_wifi() {
    Serial.printf("Connecting to %s", ssid);
    WiFi.begin(ssid, password);
    while (WiFi.status() != WL_CONNECTED) {
        delay(500); Serial.print(".");
    }
    Serial.printf("\nWiFi connected, IP: %s\n", WiFi.localIP().toString().c_str());
}

// --- MQTT Reconnection ---
void reconnect() {
    while (!client.connected()) {
        Serial.print("Attempting MQTT connection...");
        String clientId = "ESP32_JSON_" + String(random(0xffff), HEX);
        if (client.connect(clientId.c_str())) {
            Serial.println("connected");
        } else {
            Serial.printf("failed (rc=%d), retrying in 5s\n", client.state());
            delay(5000);
        }
    }
}
